name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  GO_VERSION: "1.23"
  REGISTRY: docker.io
  IMAGE_NAME: jbcom/vault-secret-sync
  HELM_REGISTRY: oci://registry-1.docker.io/jbcom/vault-secret-sync

jobs:
  # ============================================
  # TEST
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-go v6.1.0
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      # actions/upload-artifact v5.0.0
      - name: Upload coverage
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: coverage
          path: coverage.out

  # ============================================
  # LINT
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-go v6.1.0
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # golangci/golangci-lint-action v9.2.0
      - name: golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20
        with:
          version: latest

  # ============================================
  # BUILD (PR validation)
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # docker/setup-buildx-action v3.11.1
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      # docker/build-push-action v6.18.0
      - name: Build Docker image (no push)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}

  # ============================================
  # RELEASE (tags only)
  # ============================================
  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test, lint]
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      # actions/setup-go v6.1.0
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # docker/setup-qemu-action v3.7.0
      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130

      # docker/setup-buildx-action v3.11.1
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      # docker/login-action v3.6.0
      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # docker/metadata-action v5.10.0
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=
            type=raw,value=latest

      # docker/build-push-action v6.18.0
      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.ref_name }}

      # goreleaser/goreleaser-action v6.4.0
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # HELM CHART RELEASE TO DOCKER HUB (tags only)
  # ============================================
  helm-release:
    name: Release Helm Chart to Docker Hub
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [release]
    runs-on: ubuntu-latest

    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # azure/setup-helm v4.3.1
      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4
        with:
          version: v3.14.0

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update Chart.yaml version
        run: |
          cd deploy/charts/vault-secret-sync
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" Chart.yaml
          cat Chart.yaml

      - name: Update sub-chart versions
        run: |
          for chart in deploy/charts/vault-secret-sync/charts/*/Chart.yaml; do
            if [ -f "$chart" ]; then
              sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" "$chart"
              sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" "$chart"
            fi
          done

      - name: Login to Docker Hub for Helm
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login registry-1.docker.io \
            --username ${{ secrets.DOCKERHUB_USERNAME }} \
            --password-stdin

      - name: Package Helm chart
        run: |
          helm dependency update deploy/charts/vault-secret-sync || true
          helm package deploy/charts/vault-secret-sync

      - name: Push Helm chart to Docker Hub
        run: |
          helm push vault-secret-sync-${{ steps.version.outputs.version }}.tgz ${{ env.HELM_REGISTRY }}

  # ============================================
  # AUTO-RELEASE (main branch - semantic versioning)
  # ============================================
  auto-release:
    name: Create Release Tag
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Get latest tag
        id: latest_tag
        run: |
          LATEST=$(git describe --tags --match "v*" --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST"

      - name: Determine version bump
        id: bump
        run: |
          COMMITS=$(git log ${{ steps.latest_tag.outputs.tag }}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")
          
          if echo "$COMMITS" | grep -qE "^(feat|fix|refactor|perf)(\(.+\))?!:|BREAKING CHANGE"; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE "^(fix|perf|refactor)(\(.+\))?:"; then
            echo "bump=patch" >> $GITHUB_OUTPUT
          else
            echo "bump=none" >> $GITHUB_OUTPUT
          fi

      - name: Calculate new version
        id: version
        if: steps.bump.outputs.bump != 'none'
        run: |
          CURRENT="${{ steps.latest_tag.outputs.tag }}"
          CURRENT="${CURRENT#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          case "${{ steps.bump.outputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          
          echo "version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: steps.bump.outputs.bump != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
